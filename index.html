<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Números na Imagem com Balões ou Círculos</title>
    <style>
        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            background-color: #f0f2f5;
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }
        .container {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            padding: 20px;
            max-width: 900px;
            width: 100%;
            text-align: center;
            position: relative;
            z-index: 1;
        }
        h1 {
            color: #333;
            font-size: 24px;
            margin-bottom: 20px;
        }
        #image-input {
            margin-bottom: 20px;
            padding: 10px;
            font-size: 16px;
            border: 2px solid #007bff;
            border-radius: 8px;
            cursor: pointer;
        }
        #image-input::file-selector-button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        #image-input::file-selector-button:hover {
            background-color: #0056b3;
        }
        #controls {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            justify-content: center;
            margin-bottom: 20px;
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
        }
        .control-group {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
        }
        .control-group label {
            font-size: 14px;
            color: #333;
        }
        .control-group input {
            padding: 5px;
            border-radius: 5px;
            border: 1px solid #ccc;
            font-size: 14px;
        }
        #mode-toggle {
            padding: 10px 20px;
            font-size: 16px;
            border: 2px solid #007bff;
            border-radius: 8px;
            background: none;
            cursor: pointer;
            transition: background-color 0.3s, color 0.3s;
        }
        #mode-toggle:hover {
            background-color: #007bff;
            color: white;
        }
        #image-container {
            position: relative;
            display: inline-block;
            max-width: 100%;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            overflow: visible;
        }
        #my-image {
            max-width: 100%;
            height: auto;
            display: block;
            position: relative;
            z-index: 0;
        }
        #arrow-canvas {
            display: none; /* Removido uso de canvas para setas */
        }
        .number-circle {
            position: absolute;
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: bold;
            user-select: none;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            transition: transform 0.2s;
            z-index: 2;
        }
        .number-circle:hover {
            transform: scale(1.1);
        }
        .balloon {
            border: 2px solid #333;
            border-radius: 8px;
            padding: 5px 10px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }
        .balloon textarea {
            border: none;
            font-size: 14px;
            width: 100%;
            outline: none;
            cursor: text;
            background-color: inherit;
            resize: none; /* Impede redimensionamento manual */
            overflow: hidden; /* Controla altura via JavaScript */
            padding: 2px 0; /* Pequeno padding para visibilidade */
        }
        #button-container {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 20px;
        }
        .action-button {
            padding: 12px 24px;
            font-size: 16px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.2s;
        }
        .action-button:hover {
            transform: translateY(-2px);
        }
        #clear-button {
            background-color: #6c757d;
            color: white;
        }
        #clear-button:hover {
            background-color: #5a6268;
        }
        #save-button {
            background-color: #28a745;
            color: white;
        }
        #save-button:hover {
            background-color: #218838;
        }
        @media (max-width: 600px) {
            .container {
                padding: 15px;
            }
            h1 {
                font-size: 20px;
            }
            .action-button {
                padding: 10px 20px;
                font-size: 14px;
            }
            #controls {
                gap: 10px;
                padding: 10px;
            }
            .control-group label {
                font-size: 12px;
            }
            .control-group input {
                font-size: 12px;
                padding: 4px;
            }
            .balloon textarea {
                font-size: 12px;
                width: 80px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Dynamic Image Marker</h1>
        <div id="controls">
            <div class="control-group">
                <label for="shape-color">Cor do Círculo/Balão</label>
                <input type="color" id="shape-color" value="#ff4d4f">
            </div>
            <div class="control-group">
                <label for="text-color">Cor do Texto</label>
                <input type="color" id="text-color" value="#ffffff">
            </div>
            <div class="control-group">
                <label for="circle-size">Tamanho do Círculo (px)</label>
                <input type="number" id="circle-size" min="10" max="50" value="28">
            </div>
            <div class="control-group">
                <label for="balloon-width">Largura do Balão (px)</label>
                <input type="number" id="balloon-width" min="100" max="300" value="200">
            </div>
            <div class="control-group">
                <label for="text-size">Tamanho do Texto (px)</label>
                <input type="number" id="text-size" min="8" max="30" value="16">
            </div>
        </div>
        <button id="mode-toggle">Alternar para Círculos</button>
        <input type="file" id="image-input" accept="image/*">
        <div id="image-container">
            <img id="my-image" src="" alt="Imagem carregada">
            <canvas id="arrow-canvas"></canvas>
        </div>
        <div id="button-container">
            <button id="clear-button" class="action-button">Limpar Números</button>
            <button id="save-button" class="action-button">Salvar Imagem</button>
        </div>
    </div>

    <script>
        const imageInput = document.getElementById('image-input');
        const image = document.getElementById('my-image');
        const imageContainer = document.getElementById('image-container');
        const clearButton = document.getElementById('clear-button');
        const saveButton = document.getElementById('save-button');
        const shapeColorInput = document.getElementById('shape-color');
        const textColorInput = document.getElementById('text-color');
        const circleSizeInput = document.getElementById('circle-size');
        const balloonWidthInput = document.getElementById('balloon-width');
        const textSizeInput = document.getElementById('text-size');
        const modeToggle = document.getElementById('mode-toggle');
        let numberCounter = 1;
        let numbers = [];
        let isBalloonMode = true;
        let currentShape = null;
        let isDraggingShape = false;
        let dragStartX = 0;
        let dragStartY = 0;

        // Atualizar tamanho do container quando a imagem carrega
        imageInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    image.src = e.target.result;
                    image.style.display = 'block';
                    image.onload = () => {
                        imageContainer.style.width = `${image.width}px`;
                        imageContainer.style.height = `${image.height}px`;
                    };
                };
                reader.readAsDataURL(file);
            }
        });

        // Atualizar formas (círculos ou balões)
        function updateShapes() {
            const circles = document.querySelectorAll('.number-circle');
            const balloons = document.querySelectorAll('.balloon');
            if (isBalloonMode) {
                balloons.forEach(balloon => {
                    const number = parseInt(balloon.dataset.number); // Usa data-number para rastrear
                    const numberData = numbers.find(n => n.number === number);
                    if (numberData) {
                        balloon.style.backgroundColor = shapeColorInput.value;
                        balloon.style.borderColor = textColorInput.value;
                        balloon.style.width = `${parseInt(balloonWidthInput.value)}px`;
                        const textarea = balloon.querySelector('textarea');
                        textarea.style.color = textColorInput.value;
                        textarea.style.fontSize = `${parseInt(textSizeInput.value)}px`;
                        textarea.style.backgroundColor = shapeColorInput.value;
                        balloon.style.left = `${numberData.displayX}px`;
                        balloon.style.top = `${numberData.displayY}px`;
                        textarea.style.height = 'auto'; // Resetar altura
                        textarea.style.height = `${textarea.scrollHeight}px`; // Ajustar altura ao conteúdo
                        balloon.style.height = `${textarea.scrollHeight + 10}px`; // Ajustar balão com padding
                    }
                });
            } else {
                circles.forEach(circle => {
                    const number = parseInt(circle.textContent);
                    const numberData = numbers.find(n => n.number === number);
                    if (numberData) {
                        circle.style.width = `${parseInt(circleSizeInput.value)}px`;
                        circle.style.height = `${parseInt(circleSizeInput.value)}px`;
                        circle.style.backgroundColor = shapeColorInput.value;
                        circle.style.color = textColorInput.value;
                        circle.style.fontSize = `${parseInt(textSizeInput.value)}px`;
                        circle.style.left = `${numberData.displayX - parseInt(circleSizeInput.value) / 2}px`;
                        circle.style.top = `${numberData.displayY - parseInt(circleSizeInput.value) / 2}px`;
                        circle.style.borderRadius = '50%';
                    }
                });
            }
        }

        // Adicionar forma e gerenciar cliques
        imageContainer.addEventListener('click', (event) => {
            const rect = imageContainer.getBoundingClientRect();
            const scaleX = image.naturalWidth / rect.width;
            const scaleY = image.naturalHeight / rect.height;
            const x = (event.clientX - rect.left) * scaleX;
            const y = (event.clientY - rect.top) * scaleY;
            const displayX = event.clientX - rect.left;
            const displayY = event.clientY - rect.top;

            let activeShape = null;
            if (isBalloonMode) {
                const balloons = document.querySelectorAll('.balloon');
                balloons.forEach(balloon => {
                    if (isClickInsideShape(event, balloon)) {
                        const number = parseInt(balloon.dataset.number);
                        activeShape = { balloon, numberData: numbers.find(n => n.number === number) };
                        balloon.querySelector('textarea').focus();
                    }
                });
            } else {
                const circles = document.querySelectorAll('.number-circle');
                circles.forEach(circle => {
                    if (isClickInsideShape(event, circle)) {
                        const number = parseInt(circle.textContent);
                        activeShape = { circle, numberData: numbers.find(n => n.number === number) };
                    }
                });
            }

            if (!activeShape && ((isBalloonMode && document.querySelectorAll('.balloon').length < numberCounter) || 
                               (!isBalloonMode && document.querySelectorAll('.number-circle').length < numberCounter))) {
                const shape = isBalloonMode ? document.createElement('div') : document.createElement('div');
                shape.className = isBalloonMode ? 'balloon' : 'number-circle';
                if (isBalloonMode) {
                    shape.style.backgroundColor = shapeColorInput.value;
                    shape.style.borderColor = textColorInput.value;
                    shape.style.width = `${parseInt(balloonWidthInput.value)}px`;
                    shape.style.left = `${displayX}px`;
                    shape.style.top = `${displayY}px`;
                    shape.dataset.number = numberCounter; // Armazena o número no dataset

                    const textarea = document.createElement('textarea');
                    textarea.placeholder = 'Descrição';
                    textarea.value = `${numberCounter}- `; // Número incorporado no texto
                    textarea.style.color = textColorInput.value;
                    textarea.style.fontSize = `${parseInt(textSizeInput.value)}px`;
                    textarea.style.backgroundColor = shapeColorInput.value;
                    textarea.addEventListener('input', (e) => {
                        const number = parseInt(shape.dataset.number);
                        const numberData = numbers.find(n => n.number === number);
                        if (numberData) numberData.description = e.target.value;
                        updateShapes(); // Recalcula altura ao digitar
                    });

                    shape.appendChild(textarea);
                } else {
                    shape.style.width = `${parseInt(circleSizeInput.value)}px`;
                    shape.style.height = `${parseInt(circleSizeInput.value)}px`;
                    shape.style.backgroundColor = shapeColorInput.value;
                    shape.style.color = textColorInput.value;
                    shape.style.fontSize = `${parseInt(textSizeInput.value)}px`;
                    shape.style.left = `${displayX - parseInt(circleSizeInput.value) / 2}px`;
                    shape.style.top = `${displayY - parseInt(circleSizeInput.value) / 2}px`;
                    shape.style.borderRadius = '50%';
                    shape.textContent = numberCounter;
                }
                imageContainer.appendChild(shape);
                numbers.push({ number: numberCounter, x, y, displayX, displayY, description: isBalloonMode ? `${numberCounter}- ` : undefined });
                numberCounter++;
                if (isBalloonMode) updateShapes(); // Ajusta altura após criação
            }
        });

        // Verificar se o clique está dentro da forma
        function isClickInsideShape(event, shape) {
            const rect = shape.getBoundingClientRect();
            return event.clientX >= rect.left && event.clientX <= rect.right &&
                   event.clientY >= rect.top && event.clientY <= rect.bottom;
        }

        // Eventos de arrastar formas
        imageContainer.addEventListener('mousedown', (event) => {
            const rect = imageContainer.getBoundingClientRect();
            const shapes = isBalloonMode ? document.querySelectorAll('.balloon') : document.querySelectorAll('.number-circle');
            let clickedShape = null;

            shapes.forEach(shape => {
                if (isClickInsideShape(event, shape)) {
                    clickedShape = shape;
                    currentShape = numbers.find(n => parseInt(isBalloonMode ? shape.dataset.number : shape.textContent) === n.number);
                    isDraggingShape = true;
                    dragStartX = event.clientX - rect.left - currentShape.displayX;
                    dragStartY = event.clientY - rect.top - currentShape.displayY;
                }
            });
        });

        imageContainer.addEventListener('mousemove', (event) => {
            if (isDraggingShape && currentShape) {
                const rect = imageContainer.getBoundingClientRect();
                currentShape.displayX = event.clientX - rect.left - dragStartX;
                currentShape.displayY = event.clientY - rect.top - dragStartY;
                updateShapes();
            }
        });

        imageContainer.addEventListener('mouseup', () => {
            isDraggingShape = false;
            currentShape = null;
        });
        imageContainer.addEventListener('mouseleave', () => {
            isDraggingShape = false;
            currentShape = null;
        });

        // Limpar formas
        clearButton.addEventListener('click', () => {
            const circles = document.querySelectorAll('.number-circle');
            const balloons = document.querySelectorAll('.balloon');
            circles.forEach(circle => circle.remove());
            balloons.forEach(balloon => balloon.remove());
            numbers = [];
            numberCounter = 1;
        });

        // Salvar imagem com formas
        saveButton.addEventListener('click', () => {
            if (!image.src) {
                alert('Por favor, carregue uma imagem primeiro!');
                return;
            }

            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            const img = new Image();
            img.crossOrigin = 'Anonymous';
            img.src = image.src;

            img.onload = () => {
                canvas.width = img.naturalWidth;
                canvas.height = img.naturalHeight;
                ctx.drawImage(img, 0, 0);

                numbers.forEach(({ x, y, displayX, displayY, description, number }) => {
                    const scaleX = img.naturalWidth / image.clientWidth;
                    const scaleY = img.naturalHeight / image.clientHeight;
                    const scaledDisplayX = displayX * scaleX;
                    const scaledDisplayY = displayY * scaleY;

                    if (isBalloonMode) {
                        // Balão simples
                        const balloonWidth = parseInt(balloonWidthInput.value) * scaleX;
                        const textSize = parseInt(textSizeInput.value) * scaleY;
                        ctx.fillStyle = shapeColorInput.value;
                        ctx.fillRect(scaledDisplayX, scaledDisplayY, balloonWidth, textSize + 10);
                        ctx.strokeStyle = textColorInput.value;
                        ctx.strokeRect(scaledDisplayX, scaledDisplayY, balloonWidth, textSize + 10);
                        ctx.fillStyle = textColorInput.value;
                        ctx.font = `${textSize}px Arial`;
                        ctx.textBaseline = "top";
                        ctx.fillText(description || `${number}-`, scaledDisplayX + 5, scaledDisplayY + 5, balloonWidth - 10);
                    } else {
                        // Círculo simples
                        const circleRadius = parseInt(circleSizeInput.value) / 2 * scaleX;
                        ctx.beginPath();
                        ctx.arc(scaledDisplayX, scaledDisplayY, circleRadius, 0, 2 * Math.PI);
                        ctx.fillStyle = shapeColorInput.value;
                        ctx.fill();
                        ctx.fillStyle = textColorInput.value;
                        ctx.font = `bold ${parseInt(textSizeInput.value) * scaleY}px Arial`;
                        ctx.textAlign = 'center';
                        ctx.textBaseline = 'middle';
                        ctx.fillText(number, scaledDisplayX, scaledDisplayY);
                    }
                });

                const link = document.createElement('a');
                link.download = `imagem-com-${isBalloonMode ? 'baloes' : 'circulos'}.png`;
                link.href = canvas.toDataURL('image/png');
                link.click();
            };
        });

        // Alternar entre modos
        modeToggle.addEventListener('click', () => {
            isBalloonMode = !isBalloonMode;
            modeToggle.textContent = isBalloonMode ? 'Alternar para Círculos' : 'Alternar para Balões';
            clearButton.click();
        });

        // Atualizar ao mudar configurações
        shapeColorInput.addEventListener('input', updateShapes);
        textColorInput.addEventListener('input', updateShapes);
        circleSizeInput.addEventListener('input', updateShapes);
        balloonWidthInput.addEventListener('input', updateShapes);
        textSizeInput.addEventListener('input', updateShapes);
    </script>
</body>
</html>
